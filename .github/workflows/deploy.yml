name: Deploy to EC2

on:
  push:
    branches:
      - main  # Chạy khi có push lên nhánh main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # Bước 1: Clone mã nguồn từ repository
      - name: Checkout source code
        uses: actions/checkout@v4

      #Bước 2. Tạo thư mục cố định và sao chép mã nguồn 
      - name: Check current directory
        run: pwd        

       # Bước 3: Sửa quyền truy cập thư mục redis-data
      - name: Fix permissions for redis-data
        run: |
          echo "Fixing permissions for redis-data directory..."
          sudo chown -R ubuntu:ubuntu /home/ubuntu/actions-runner/_work/Project_Booking_Tour_BE/Project_Booking_Tour_BE/redis-data
          sudo chmod -R 755 /home/ubuntu/actions-runner/_work/Project_Booking_Tour_BE/Project_Booking_Tour_BE/redis-data

      # Bước 4: Xác minh quyền truy cập
      - name: Verify redis-data permissions
        run: |
          ls -ld /home/ubuntu/actions-runner/_work/Project_Booking_Tour_BE/Project_Booking_Tour_BE/redis-data
      
      # Bước 5: Dọn dẹp thư mục redis-data nếu cần
      - name: Clean redis-data directory
        run: |
          echo "Cleaning redis-data directory..."
          sudo rm -rf /home/ubuntu/actions-runner/_work/Project_Booking_Tour_BE/Project_Booking_Tour_BE/redis-data

      # Bước 6: Dọn dẹp các container Docker cũ và khởi động lại
      - name: Clean up Docker volumes
        run: |
          docker volume prune -f  # Xóa tất cả các volume không còn được sử dụng, bao gồm redis-data
      
      # Bước 7: Build mới và chạy lại Docker Compose
      - name: Run docker-compose
        run: |
          cd /home/ubuntu/actions-runner/_work/Project_Booking_Tour_BE/Project_Booking_Tour_BE
          # Build lại các container với image mới
          docker-compose build
          
          # Dừng và xóa các container cũ
          docker-compose down
          
          # Khởi động lại container với image mới
          docker-compose up -d
          

